import{u as H,r as o,j as e}from"./index-fvoixXIL.js";import{d as V,n as Q,P as U,S as W,q as X,r as Y,v as P,w as Z,D as _,x as ee,y as te,z as se,c as ae,A as ne,l as R,k as ie,E as le,F as oe,G as re,H as ce,I as de,J as ge,L as he,j as O}from"./route-Ds0QhG_N.js";import{a6 as c,a7 as xe,a9 as me,a4 as A}from"./index-BCTBe50e.js";import{u as ue,C as fe,a as pe}from"./use-custom-filters-CAGajgby.js";import"./index-xR07Ve0S.js";function ye({edit:l,onCancel:F,onConfirm:C}){const a=H(),[s,m]=o.useState(l??{}),{incomes:E,expenses:T}=V(),I=s.type===void 0?void 0:s.type==="income"?a("income"):a("expense"),p=s.type==="income"?E:s.type==="expense"?T:[],z=s.categoryId===void 0?a("original-category"):p.find(i=>i.id===s.categoryId)?.name,{tags:N}=Q(),D=s.tagIds===void 0?a("original-tag"):s.tagIds.length===0?a("no-tags"):s.tagIds.map(i=>N.find(d=>d.id===i)?.name).join(",");return e.jsxs(U,{title:a("batch-edit"),right:e.jsx(c,{onClick:()=>{C?.(s)},children:a("confirm")}),onBack:F,className:"h-full overflow-hidden flex flex-col gap-2",children:[e.jsxs("div",{className:"flex justify-between py-2 px-4 border-b",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{children:a("change-bills-type")}),e.jsx("div",{className:"text-xs opacity-60",children:s.type===void 0?a("ledger-will-keep-original-type"):a("ledger-type-will-be-updated-to",{n:I})})]}),e.jsxs(W,{value:s.type,onValueChange:i=>{m(d=>({...d,type:i,categoryId:void 0}))},children:[e.jsx(X,{className:"w-fit",children:e.jsx("div",{children:I})}),e.jsxs(Y,{children:[e.jsx(P,{value:"income",children:a("income")}),e.jsx(P,{value:"expense",children:a("expense")})]})]})]}),e.jsxs("div",{className:"flex justify-between py-2 px-4 border-b",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{children:a("change-categories-of-ledger")}),e.jsx("div",{className:"text-xs opacity-60",children:s.categoryId===void 0?a("ledger-will-keep-original-category"):a("ledger-category-will-updated-to",{n:z})})]}),e.jsx(Z,{list:p,value:s.categoryId,onValueChange:i=>{m(d=>({...d,categoryId:i}))},placeholder:"原有类别"})]}),e.jsxs("div",{className:"flex justify-between py-2 px-4 border-b",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{children:a("change-bills-tags")}),e.jsx("div",{className:"text-xs opacity-60",children:s.tagIds===void 0?a("ledger-will-keep-original-tags"):s.tagIds.length===0?a("ledger-tags-will-be-clear"):a("ledger-tags-will-be-changed")})]}),e.jsxs(_,{children:[e.jsx(ee,{asChild:!0,children:e.jsx(c,{variant:"outline",className:"px-2 md:px-4 py-2 text-xs md:text-sm",children:e.jsx("div",{className:"max-w-[120px] truncate",children:D})})}),e.jsx(te,{className:"w-56",align:"end",children:N.map(i=>e.jsx(se,{checked:s.tagIds?.includes(i.id),onCheckedChange:d=>{m(y=>{const j=new Set(y.tagIds);d?j.add(i.id):j.delete(i.id);const S=Array.from(j);return{...y,tagIds:S}})},children:i.name},i.id))})]})]})]})}const[je,ve]=xe(ye,{dialogTitle:"Batch Edit",dialogModalClose:!0,fade:!0,contentClassName:"rounded-md max-h-[65vh] w-[90vw] max-w-[500px]"}),b=[{by:"time",order:"desc",icon:"icon-[mdi--sort-clock-ascending-outline]",label:"newest"},{by:"time",order:"asc",icon:"icon-[mdi--sort-clock-descending-outline]",label:"oldest"},{by:"amount",order:"desc",icon:"icon-[mdi--sort-descending]",label:"highest-amount"},{by:"amount",order:"asc",icon:"icon-[mdi--sort-ascending]",label:"lowest-amount"}];function Se(){const l=H(),{baseCurrency:F}=ae(),{categories:C}=V(),{state:a}=ne(),[s,m]=o.useState(()=>{const t=a?.filter;return t?{baseCurrency:F.id,...t,categories:C.filter(n=>t.categories?.some(u=>u===n.id||u===n.parent)).map(n=>n.id)}:{}}),[E,T]=o.useState(!1),I=o.useCallback(()=>{m({})},[]),[p,z]=o.useState([]),[N,D]=o.useState(!1),i=o.useCallback(async()=>{const t=R.getState().currentBookId;if(!t)return;B(!1),v([]);const n=await me.filter(t,s);z(n)},[s]),d=ie(),{addFilter:y}=ue(),j=o.useCallback(async()=>{const t=prompt(l("please-enter-a-name-for-current-filter"));if(!t||!R.getState().currentBookId)return;const u=await y(t,{filter:s});d(`/stat/${u}`)},[y,s,d,l]),S=o.useRef(!!a?.filter);o.useEffect(()=>{S.current&&(i(),S.current=!1)},[i]);const[k,q]=o.useState(0),h=o.useMemo(()=>{const t=b[k]??b[0];return le(p,[t.by],[t.order])},[p,k]),[L,B]=o.useState(!1),[r,v]=o.useState([]),G=t=>{v(n=>n.includes(t)?n.filter(u=>u!==t):[...n,t])},J=r.length===0?!1:r.length===h.length?!0:"indeterminate",K=async()=>{confirm(l("batch-delete-confirm",{n:r.length}))&&(B(!1),await O.getState().removeBills(r),await i())},$=async()=>{const t=r.reduce((f,g,w)=>{const x=h.find(M=>M.id===g);return x?w===0?{type:x.type,categoryId:x.categoryId}:{type:x.type===f.type?x.type:void 0,categoryId:x.categoryId===f.categoryId?x.categoryId:void 0}:f},{type:void 0,categoryId:void 0}),n=await ve(t),u=r.map(f=>{const g={...h.find(w=>w.id===f)};if(g){if(n.type!==void 0){const w=g.type!==n.type;if(g.type=n.type,n.categoryId!==void 0)g.categoryId=n.categoryId;else if(w){const x=C.find(M=>M.type===n.type).id;g.categoryId=x}}return n.tagIds!==void 0&&(g.tagIds=n.tagIds),{id:g.id,entry:g}}}).filter(f=>f!==void 0);await O.getState().updateBills(u),await i()};return e.jsxs("div",{className:"w-full h-full p-2 flex justify-center overflow-hidden page-show",children:[e.jsxs("div",{className:"h-full w-full px-2 max-w-[600px] flex flex-col",children:[e.jsx("div",{className:"search w-full flex justify-center pt-4",children:e.jsxs("div",{className:"w-full h-10 shadow-md rounded-sm flex items-center px-4 focus-within:(shadow-lg)",children:[e.jsx("div",{className:"flex-1",children:e.jsx(fe,{visible:!!s.comment?.length,onClear:()=>m(t=>({...t,comment:void 0})),children:e.jsx("input",{value:s.comment??"",type:"text",maxLength:50,className:"w-full bg-transparent outline-none",onChange:t=>{m(n=>({...n,comment:t.target.value}))}})})}),e.jsx(c,{variant:"ghost",className:"p-3 rounded-md",onClick:()=>{i(),setTimeout(()=>{D(!0)},1e3)},children:e.jsx("i",{className:"icon-[mdi--search]"})})]})}),e.jsxs(oe,{open:E,onOpenChange:T,className:"flex flex-col group pt-3 text-xs md:text-sm font-medium",children:[e.jsx(re,{className:"data-[state=open]:animate-collapse-open data-[state=closed]:animate-collapse-close data-[state=closed]:overflow-hidden",children:e.jsx(pe,{form:s,setForm:m})}),e.jsxs("div",{className:"w-full flex justify-between px-2 pt-1",children:[e.jsx(c,{variant:"ghost",onClick:I,children:l("reset")}),N&&e.jsxs(c,{className:"text-xs underline animate-content-show",variant:"ghost",size:"sm",onClick:j,children:[e.jsx("i",{className:"icon-[mdi--coffee-to-go-outline]"}),l("save-for-analyze")]}),e.jsx(ce,{persistKey:"filterHintShows",content:"点击展开详细筛选面板",children:e.jsx(de,{asChild:!0,children:e.jsxs(c,{variant:"ghost",children:[e.jsx("i",{className:"group-[[data-state=open]]:icon-[mdi--filter-variant-minus] group-[[data-state=closed]]:icon-[mdi--filter-variant-plus]"}),l("filter")]})})})]})]}),e.jsxs("div",{className:A("flex items-center justify-between px-4 text-xs text-foreground/80",L&&"pl-0"),children:[e.jsx("div",{className:"flex gap-2 items-center",children:L?e.jsxs(e.Fragment,{children:[e.jsx(ge,{checked:r.length===0?!1:r.length===h.length?!0:"indeterminate",onClick:()=>{v(J===!0?[]:h.map(t=>t.id))}}),e.jsx(c,{className:"p-1 h-fit",variant:"ghost",size:"sm",onClick:()=>{B(!1),v([])},children:l("cancel")}),e.jsxs("span",{children:[r.length,"/",h.length]}),r.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(c,{className:"p-1 h-fit",variant:"ghost",size:"sm",onClick:$,children:l("edit")}),e.jsx(c,{className:"p-1 h-fit text-destructive",variant:"ghost",size:"sm",onClick:K,children:l("delete")})]})]}):e.jsxs(e.Fragment,{children:[h.length>0&&e.jsx(c,{className:"p-1 h-fit",variant:"ghost",size:"sm",onClick:()=>{B(!0)},children:l("multi-select")}),l("total-records",{n:h.length})]})}),e.jsx("div",{children:e.jsxs(c,{size:"sm",variant:"ghost",onClick:()=>{q(t=>t===b.length-1?0:t+1)},children:[e.jsx("i",{className:A(b[k].icon)}),l(b[k].label)]})})]}),e.jsx(he,{bills:h,showTime:!0,selectedIds:L?r:void 0,onSelectChange:G,afterEdit:i})]}),e.jsx(je,{})]})}export{Se as default};
